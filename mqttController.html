<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Rover (mau-2-cpu)</title>
  <style>
    body { 
      font-family: sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin-top: 50px; 
    }
    h1 { margin-bottom: 20px; }
    .controls { 
      display: grid; 
      grid-template-areas:
        ". forward ."
        "left stop right"
        ". backward .";
      gap: 10px; 
    }
    .controls button { 
      padding: 15px 25px; 
      font-size: 1rem; 
      border: none; 
      border-radius: 5px; 
      cursor: pointer; 
      background: #007acc; 
      color: white; 
      user-select: none;
    }
    .controls button:active { background: #005f99; }
  </style>
</head>
<body>
  <h1>Panel de Control del Rover</h1>
  <div class="controls">
    <button id="forward" data-cmd="2"    style="grid-area: forward;">Adelante (W)</button>
    <button id="left"    data-cmd="4"    style="grid-area: left;">Izquierda (A)</button>
    <button id="stop"    data-cmd="0"    style="grid-area: stop;">Detener</button>
    <button id="right"   data-cmd="3"    style="grid-area: right;">Derecha (D)</button>
    <button id="back"    data-cmd="1"    style="grid-area: backward;">Atrás (S)</button>
  </div>

  <!-- MQTT.js desde CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const wsUrl = 'wss://e5547786a1c644639b5584dd5bebea46.s1.eu.hivemq.cloud:8884/mqtt';
    const options = {
      username: 'bhs123',
      password: 'Abcd1234',
      clientId: 'web_' + Math.random().toString(16).substr(2, 8),
      keepalive: 30,
      clean: true,
      reconnectPeriod: 2000
    };
    const client = mqtt.connect(wsUrl, options);
    client.on('connect', () => console.log('✅ Conectado a MQTT'));
    client.on('error', err => console.error('❌ Error MQTT:', err));

    function sendCmd(cmd) {
      client.publish('movement', String(cmd), { qos: 0 });
      console.log('Publicado:', cmd);
    }

    // Conjunto de comandos activos
    const activeCmds = new Set();

    // Botones: agregan/quitan su cmd al presionar/soltar
    document.querySelectorAll('.controls button').forEach(btn => {
      const cmd = btn.dataset.cmd;
      btn.addEventListener('mousedown', () => activeCmds.add(cmd));
      btn.addEventListener('mouseup',   () => activeCmds.delete(cmd));
      btn.addEventListener('mouseout',  () => activeCmds.delete(cmd));
    });

    // Teclado: W/A/S/D
    const keyMap = { 'w':'2', 'a':'4', 's':'1', 'd':'3' };
    window.addEventListener('keydown', e => {
      const k = e.key.toLowerCase();
      if (keyMap[k]) {
        activeCmds.add(keyMap[k]);
        e.preventDefault();
      }
    });
    window.addEventListener('keyup', e => {
      const k = e.key.toLowerCase();
      if (keyMap[k]) {
        activeCmds.delete(keyMap[k]);
        e.preventDefault();
      }
    });

    // Envío continuo cada 100ms
    setInterval(() => {
      if (activeCmds.size === 0) {
        sendCmd(0);
      } else {
        activeCmds.forEach(cmd => sendCmd(cmd));
      }
    }, 100);
  </script>
</body>
</html>
